# LinQ to Sqlite

[TOC]

## Reference

### NuGet 套件

#### System.Data.SQLite.Linq

有相容性問題，現版本.net似乎無法相容

![img01](https://i.imgur.com/4zVNofm.png)

#### LinqToDB

https://github.com/linq2db/linq2db

https://www.itread01.com/content/1548907043.html

適用於各種DataBase不過這邊僅使用在sqlite

## LinqToDB

以下以使用NuGet套件LinqToDB的情況下進行說明。

### SQLite模板檔案

T4教學文章https://dotblogs.com.tw/johnny/2014/04/29/t4-step-by-step

其他DB的模板https://github.com/linq2db/examples

```
<#@ template language="C#" debug="True" hostSpecific="True"                        #>
<#@ output extension=".generated.cs"                                               #>
<#@ include file="$(ProjectDir)LinqToDB.Templates\LinqToDB.SQLite.Tools.ttinclude" #>
<#@ include file="$(ProjectDir)LinqToDB.Templates\PluralizationService.ttinclude"  #>
<#
	/*
		1. Copy this file to a folder where you would like to generate your data model,
		   rename it, and delete .txt extension. For example:

			MyProject
				DataModels
					MyDatabase.tt

		2. Modify the connection settings below to connect to your database.

		3. Add connection string to the web/app.config file:

			<connectionStrings>
				<add name="MyDatabase" connectionString="Data Source=MyDatabase.sqlite" providerName="SQLite" />
			</connectionStrings>

		4. To access your database use the following code:

			using (var db = new MyDatabaseDB())
			{
				var q =
					from c in db.Customers
					select c;

				foreach (var c in q)
					Console.WriteLine(c.ContactName);
			}

		5. See more at https://github.com/linq2db/t4models/blob/master/Templates/!ReadMe.LinqToDB.md.
	*/

	NamespaceName = "DataModels";

	LoadSQLiteMetadata(@"C:\Data", "MyDatabase.sqlite");
//	LoadSQLiteMetadata(string connectionString);

	GenerateModel();
#>
```

屬於執行階段文字範本檔案(T4)

作用是生成.cs`<#@ output extension=".generated.cs"#>`

```xml
<#@ include file="$(ProjectDir)LinqToDB.Templates\LinqToDB.SQLite.Tools.ttinclude" #>
<#@ include file="$(ProjectDir)LinqToDB.Templates\PluralizationService.ttinclude"  #>
```

```C#
	NamespaceName = "DataModels";

	LoadSQLiteMetadata(@"C:\Data", "MyDatabase.sqlite");
```

修改以上部分後將這個檔案加入專案(或是新增執行階段文字範本檔案並貼上這段文字)

註：LinqToDB.Templates\LinqToDB.SQLite.Tools.ttinclude以及LinqToDB.Templates\PluralizationService.ttinclude這兩個檔案要在NuGet安裝**linq2db.SQLite**才會出現。

註：使用模板生成.cs的話可以略過下方一部份的步驟，基本上只要在做完Congfiguration就可以linq了。



#### 找不到命名空間

![img05](https://i.imgur.com/WH7OESx.png)

生成的檔案有時(?)會發生如上情形

`System.Data.Entity.Design`查過許多NuGet套件都沒有提供，後來是直接載dll檔案來引用。

另外還有一些類別是在[Microsoft.VisualStudio.TextTemplating](https://docs.microsoft.com/en-us/dotnet/api/microsoft.visualstudio.texttemplating?view=visualstudiosdk-2019)裡面，嘗試引用NuGet套件但是不相容。(因為是.NetCore3.1專案的關係?)

---

重開.NetFrameWork4.7的Console專案測試，證實是.NetCore的問題，生成的程式碼如下，至於如何將其適用在.NetCore還待了解。

```C#
//---------------------------------------------------------------------------------------------------
// <auto-generated>
//    This code was generated by T4Model template for T4 (https://github.com/linq2db/linq2db).
//    Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.
// </auto-generated>
//---------------------------------------------------------------------------------------------------

#pragma warning disable 1591

using System;

using LinqToDB;
using LinqToDB.Mapping;

namespace DataModels
{
	/// <summary>
	/// Database       : atelierLaDiDaA17JPSqlite
	/// Data Source    : atelierLaDiDaA17JPSqlite
	/// Server Version : 3.24.0
	/// </summary>
	public partial class AtelierLaDiDaA17JPSqliteDB : LinqToDB.Data.DataConnection
	{
		public ITable<Sophie> Sophie { get { return this.GetTable<Sophie>(); } }

		public AtelierLaDiDaA17JPSqliteDB()
		{
			InitDataContext();
			InitMappingSchema();
		}

		public AtelierLaDiDaA17JPSqliteDB(string configuration)
			: base(configuration)
		{
			InitDataContext();
			InitMappingSchema();
		}

		partial void InitDataContext  ();
		partial void InitMappingSchema();
	}

	[Table("Sophie$")]
	public partial class Sophie
	{
		[Column("No#"), Nullable] public double? No         { get; set; } // real
		[Column(),      Nullable] public string  Name       { get; set; } // varchar(255)
		[Column(),      Nullable] public string  Attribute1 { get; set; } // varchar(255)
		[Column(),      Nullable] public string  Attribute2 { get; set; } // varchar(255)
		[Column(),      Nullable] public string  Attribute3 { get; set; } // varchar(255)
		[Column(),      Nullable] public string  Attribute4 { get; set; } // varchar(255)
		[Column(),      Nullable] public string  Attribute5 { get; set; } // varchar(255)
		[Column(),      Nullable] public string  Type1      { get; set; } // varchar(255)
		[Column(),      Nullable] public string  Type2      { get; set; } // varchar(255)
		[Column(),      Nullable] public string  Type3      { get; set; } // varchar(255)
		[Column(),      Nullable] public string  Type4      { get; set; } // varchar(255)
		[Column(),      Nullable] public string  Source1    { get; set; } // varchar(255)
		[Column(),      Nullable] public string  Source2    { get; set; } // varchar(255)
		[Column(),      Nullable] public string  Source3    { get; set; } // varchar(255)
		[Column(),      Nullable] public string  Source4    { get; set; } // varchar(255)
		[Column(),      Nullable] public char?   TRIAL973   { get; set; } // char(1)
	}
}

#pragma warning restore 1591
```



### ConnectionString

同System.Sqlite寫法

```C#
            string dataPath = "C:\\Users\\admin\\source\\repos\\20200831LinQ_SQLite_Test\\20200831LinQ_SQLite_Test\\DB\\FenrirFS.db";
            string connectionString = $"data source ={dataPath}";
```

其他情況可以參考官方提供的Connection String 寫法 https://www.connectionstrings.com/sqlite/

### 得到options builder以及data connection物件

```C#
            var builder = new LinqToDbConnectionOptionsBuilder();
            builder.UseSQLite(connectionString);
            var dc = new DataConnection(builder.Build());
```

### Configuration

> In your `web.config` or `app.config` make sure you have a connection string (check [this file](https://github.com/linq2db/linq2db/blob/master/Source/LinqToDB/ProviderName.cs) for supported providers)
>
> ```xml
> <connectionStrings>
>   <add name="Northwind" 
>     connectionString = "Server=.\;Database=Northwind;Trusted_Connection=True;Enlist=False;" 
>     providerName     = "SqlServer" />
> </connectionStrings>
> ```

在Console專案中加入xml檔名為app.config，接著using System.Configuration;

以下是我修改的config檔案

```xml
<?xml version="1.0" encoding="utf-8" ?>
<configuration>
  <connectionStrings>
  <add name="FenrirFS"
    connectionString = "data source =C:\\Users\\admin\\source\\repos\\20200831LinQ_SQLite_Test\\20200831LinQ_SQLite_Test\\DB\\FenrirFS.db"
    providerName     = "SQLite" />
  </connectionStrings>
</configuration>
```

以下測試可以順利取得物件

```C#
var con = ConfigurationManager.ConnectionStrings;
```

### Connection String Setting Provider

> Net Core does not support `System.Configuration` until 3.0 so to configure connection strings you should implement `ILinqToDBSettings`, for example:
>
> ```c#
> public class ConnectionStringSettings : IConnectionStringSettings
> {
>     public string ConnectionString { get; set; }
>     public string Name { get; set; }
>     public string ProviderName { get; set; }
>     public bool IsGlobal => false;
> }
> 
> public class MySettings : ILinqToDBSettings
> {
>     public IEnumerable<IDataProviderSettings> DataProviders => Enumerable.Empty<IDataProviderSettings>();
> 
>     public string DefaultConfiguration => "SqlServer";
>     public string DefaultDataProvider => "SqlServer";
> 
>     public IEnumerable<IConnectionStringSettings> ConnectionStrings
>     {
>         get
>         {
>             yield return
>                 new ConnectionStringSettings
>                 {
>                     Name = "Northwind",
>                     ProviderName = "SqlServer",
>                     ConnectionString = @"Server=.\;Database=Northwind;Trusted_Connection=True;Enlist=False;"
>                 };
>         }
>     }
> }
> ```

似乎是拿來替代Configuration，二擇一即可(?)

我的寫法如下

```C#
    public class ConnectionStringSettings : IConnectionStringSettings
    {
        public string ConnectionString { get; set; }
        public string Name { get; set; }
        public string ProviderName { get; set; }
        public bool IsGlobal => false;
    }

    public class MySettings : ILinqToDBSettings
    {
        public IEnumerable<IDataProviderSettings> DataProviders => Enumerable.Empty<IDataProviderSettings>();

        public string DefaultConfiguration => "SQLite";
        public string DefaultDataProvider => "SQLite";

        public IEnumerable<IConnectionStringSettings> ConnectionStrings
        {
            get
            {
                yield return
                    new ConnectionStringSettings
                    {
                        Name = "FenrirFS",
                        ProviderName = "SQLite",
                        ConnectionString = "data source =C:\\Users\\admin\\source\\repos\\20200831LinQ_SQLite_Test\\20200831LinQ_SQLite_Test\\DB\\FenrirFS.db"
                    };
            }
        }
    }

```

### 資料庫相關類別

根據測試用的db

![img02](https://i.imgur.com/K3y6YkX.png)

![img03](https://i.imgur.com/VEnmlRd.png)

db class

```C#
    public class FenrirFS:DataConnection
    {
        public FenrirFS():base("FenrirFS") {}
        public ITable<dbversion> dbversion => GetTable<dbversion>();
    }
```

建構式的引數使用方式仍未明

![img04](https://i.imgur.com/3H75Xnr.png)



table class

```C#
    [Table(Name = "dbversion")]
    public class dbversion
    {
        [Column(Name = "ID"), NotNull]
        public int ID { get; set; }
        [Column(Name = "version"), NotNull]
        public int version { get; set; }
        [Column(Name = "required_prog_ver"), NotNull]
        public int required_prog_ver { get; set; }
        [Column(Name = "preview"), NotNull]
        public int preview { get; set; }
        [Column(Name = "lastupdate"), NotNull]
        public string lastupdate { get; set; }
    }
```

## 疑難雜症

### 資料庫登入失敗

* 檢查Configuration設定是否完成
* 檢查ConnectionString帳號密碼是否正確(沒有就不用設)